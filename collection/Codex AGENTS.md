# AGENTS.md — 全局指南


## 0. 阅读须知
- 本指南适用于仓库全部目录，除非子目录另有 AGENTS.md 覆盖。
- 坚持“强制优先、结果导向、可审计”，所有流程需可追溯。
- 若与本指南冲突的用户显式指令出现，必须遵循并在前置说明记录偏差原因，同时同步该偏差至 Serena 知识记忆。

## 1. 治理总则
### 1.1 适用范围
- 覆盖整个仓库全目录；若子目录另有 `AGENTS.md`，以子目录指南为准。
- 始终坚持“强制优先、结果导向、可审计”，确保所有操作留痕可追溯。

### 1.2 执行优先级
- 禁用一切 CI/CD 自动化；构建、测试、发布、验证必须通过本地 AI 驱动流程执行，远端流水线保持停用。
- 新建项目需持有用户显式批准，并在 Serena 登记审批链路；如无指令，默认禁止自发创建。
- 每个任务在开始与结束时应同步任务日志至 Serena 知识记忆，过期结论需及时覆盖。
- 全部沟通、代码注释与文档统一使用中文，新建文件编码需为 UTF-8（无 BOM）。
- 回复需包含“前置说明”，若调用外部工具须追加“工具调用简报”。
- 工具使用遵循：Sequential Thinking 必须先行；Serena 负责统一调度与结构化检索；`update_plan` / `TodoWrite` 维护在制项；网络检索遵循 Context7 → DeepWiki → 其他渠道顺序，并记录每次降级原因。

### 1.3 治理原则
1. 标准化生态优先：能用主流稳定库或官方 SDK 时不得自研，且需记录替换进度。
2. 质量优先：出现报错时先行修复，所有结论必须具备证据支撑。
3. 工具优先：研究、实现与验证均需依托既定工具链，由 Serena 统筹调用。
4. 全景洞察：结合完整代码上下文与多来源数据形成决策。
5. 透明留痕：关键决策、证据、变更等必须写入 Serena，保持可审计性。
6. 结果导向：以量化目标、SLO/SLI 与交付成果衡量工作成效。
7. 持续改进：任务收尾需复盘并刷新知识库或最佳实践。

## 2. 强制约束（MUST）
### 2.1 工作执行
- 仅可运行安全命令，严禁 `rm -rf` 等破坏性操作或泄露密钥、令牌、内部链接。
- 新增或修改代码时补齐中文文档与必要细节注释，禁止占位或 `NotImplemented`。
- 若输出中断（stream error），需基于已写内容无缝续写。

### 2.2 交互与文档
- 在记录中明确假设、数据时效、输入来源与不确定性。
- 使用规范化模板，确保回复与文档可追溯。
- 所有偏差说明与关键沟通结论需同步登记至 Serena 知识记忆。

### 2.3 安全与合规
- 网络仅用于读取公开资料，优先官方与权威来源，禁止上传敏感信息。
- 遇 HTTP 429 固定退避 20s；HTTP 5xx 或超时退避 2s 后最多一次重试，仍失败须提供保守离线答案并说明局限与下一步。
- 默认仅维持最低安全基线，任何多余的安全性设计必须拒绝或拆除，并在 Serena 中记录处理结果。

### 2.4 变更策略
- 必须优先复用标准化生态能力，凡可使用主流库/官方 SDK 的场景禁止自研实现，并清理既有自研组件以降低维护面。
- 默认采取破坏性改动并拒绝向后兼容，主动清理过时代码、接口与文档。
- 交付必须完整具体，禁止提交 MVP 或占位方案。
- 在 PR 或交付说明中明确迁移方案；若无迁移需求需声明“无迁移，直接替换”。

### 2.5 操作留痕
- 任何偏差、风险、工具调用与验证结果，须在行动当下同步录入 Serena 知识记忆，同时标注任务编号、时间戳与证据指向。
- 所有文件读写、制品存储与版本留存必须通过 Serena 完成，严禁在仓库新增任何额外本地目录或使用线下介质。
- 若因用户指令无法使用 Serena，应在回复“前置说明”中写明原因，并于条件允许时补录。
- 任务日志需包含目标、操作、输出、后续动作，确保复盘时可追溯。

## 3. 工具与调研平台
### 3.0 工具矩阵概览
| 工具 | 核心职责 | Serena 联动要求 |
| --- | --- | --- |
| Serena MCP | 统一调度代码/知识工具、维护知识记忆、执行编辑操作，并提供结构化检索能力 | 所有指令由 Serena 发起并登记留痕 |
| Sequential Thinking MCP | 产出可追溯思考链，驱动后续行动决策 | 思考结论需回写 Serena 并触发对应任务计划 |
| Context7 MCP | 获取官方文档与权威资料的首选通道 | 每次检索记录关键词、版本与访问日期 |
| DeepWiki MCP | 补充社区实践与框架洞见 | 记录失败或补充检索原因，必要时反馈至 Serena 任务卡 |

### 3.1 Serena MCP（首选代码/知识工具）
- **接入校验**：每次启动 Codex 会话先调用 `serena__activate_project`／`serena__check_onboarding_performed` 并通过 `uv run serena tools list` 或 Dashboard 交叉确认 Serena 已联通，在“前置说明”记录结果；如检测失败立即暂停任务并协调恢复方案。
- **上下文与模式策略**：依据目标选择合适的 Context/Mode（如 `codex`、`ide-assistant`、`planning`、`editing`），所有切换须在计划或知识记忆中写明动机、预期影响与回滚触发条件。
- **结构化检索主线**：执行分析与改动时严格依序使用 `serena__find_symbol` → `serena__search_for_pattern` → 编辑类工具（`serena__insert_after_symbol` 等），禁止跳过检索直接手改，必要时结合 `serena__find_referencing_symbols` 评估影响面。
- **索引维护**：首次接手项目或在大规模重构前执行 `serena project index`；结构变更后按需触发 `serena__refresh_index`，若索引失步需记录上下文并调用 `serena__clear_settings` 后重建。
- **工具巡检与扩展**：在阶段性里程碑审查 `serena tools list` 与 `--only-optional` 输出，根据任务场景启用或停用可选工具，并在计划中登记启用时机、目标与验证方式。
- **知识资产治理**：所有关键决策、验证证据通过 `serena__write_memory` 入库；周期性使用 `serena__list_memories`、`serena__think_about_collected_information` 清理过期结论，保持记忆库最新。
- **质量/指标监控**：需要评估 Serena 效能时开启 `record_tool_usage_stats` 并定期查阅 Dashboard 的调用耗时、失败率，将洞察纳入复盘与改进计划。
- **最小安全基线**：需要只读分析或外部评审时启用 `read_only: true` 限制编辑工具，结束后恢复默认并记录窗口与影响。
- **故障处置与降级**：遇到工具异常时按照“记录上下文 → `serena__refresh_index`/`serena__check_temp_directory` → `serena__clear_settings`”顺序排障，若仍失败，在计划中登记风险并按治理流程启用人工替代方案。

### 3.2 Sequential Thinking MCP

- **必填字段**：每次调用均需补全 `thought`、`next_thought_needed`、`thought_number`、`total_thoughts` 等核心参数，保持序号单调递增并视实际情况动态调整 `total_thoughts`。
- **分支治理**：探索替代路径时配合 `branch_from_thought` + `branch_id`，修订历史则使用 `is_revision` + `revises_thought`，保证思考链路可追踪。
- **上下文回写**：充分利用 `current_step`、`previous_steps`、`remaining_steps` 保存优先级、期望产出与后续条件，便于在计划工具与执行工具之间同步。
- **工具推荐落地**：对 `recommended_tools` 返回的置信度、优先级与替代项逐一响应，先在 plan 中备案再执行，防止遗漏重要建议。
- **记忆控管**：定期清理历史记录或总结关键结论，避免长链导致上下文漂移，同时保留关键节点供复盘复用。

### 3.3 Context7 MCP（upstash/context7）
- **调用顺序**：在 Codex 中始终先执行 `context7__resolve-library-id` 获取精准库 ID，再调用 `context7__get-library-docs`；可按需传入 `topic` 聚焦子领域，或通过 `tokens` 控制上下文规模。
- **检索定位**：提交查询前先在计划中记录目标与关键词，调用后将文档版本、访问日期与关键摘录写入 Serena 知识记忆。
- **用例最佳化**：优先查阅官方 API、升级指引、Breaking Changes；若检索结果与项目现状不符，需在计划中挂起风险条目并安排验证。
- **降级策略**：Context7 无法返回结果时，按顺序转向 DeepWiki，再使用 `web.run`；每次降级需在知识记忆中注明原因与时间戳。
- **上下文控制**：避免一次性拉取过长文档，拆分为多个聚焦请求，并在连续调用间同步当前进展至 `update_plan`。

### 3.4 DeepWiki MCP
- **定位场景**：当 Context7 未覆盖或需要社区最佳实践时调用 DeepWiki，优先核对仓库星级、活跃度与最近提交日期。
- **工具组合**：根据需求选择 `deepwiki__read_wiki_structure` 定位章节，`deepwiki__read_wiki_contents` 获取详情，或用 `deepwiki__ask_question` 快速提取关键信息，并在调用日志中注明所用接口。
- **提问策略**：问题描述需包含目标、失败症状与上下文关键词，必要时拆分多个短问题，减少歧义并提升命中率。
- **输出管理**：整理出的经验、代码片段或风险提示需回写 Serena 知识记忆，注明仓库地址、访问日期与可靠性评估。
- **合规界限**：仅检索公共资料；涉及私有或授权仓库时，需在计划中记录审批链路并等待用户确认后再行操作。

### 3.5 外部检索与降级

- **降级路径**：仅在 Context7 与 DeepWiki 均失败或不适用时使用 `web.run` 等公开渠道，并说明触发原因。
- **退避策略**：遵循 HTTP 429 退避 20s、5xx/超时 2s 后至多重试一次的规范，超限时提供保守答案与下一步建议。
- **数据留痕**：详实记录检索语句、筛选条件、访问日期、失败情况及链接，统一回填 Serena。
- **敏感控制**：禁止上传内部信息或受限文件，下载资料前确认版权与合规要求。

### 3.6 工具留痕与知识治理

- 所有关键决策、证据与复盘必须以 Serena 知识记忆条目形式实时归档，禁止在仓库目录或线下介质存放；如需引用外部文件，应在 Serena 中登记链接、校验和与最后验证日期。
- 重要知识需定期复核并删除过期或失效条目，确保记忆库保持最新状态且可审计。

### 3.7 AI 本地自动验证工具链
- 验证活动须通过 AI 驱动的本地自动执行（如 Serena `execute_shell_command` 配合脚本编排）完成，禁止依赖远端 CI 服务。
- 需维护标准化的本地验证脚本模板，并在 Serena 记录脚本版本、验证频率和适用范围。
- 若本地自动执行失败，应立即记录原因、调整脚本并在 Serena 更新处置结果。

### 3.8 轻量观测方案
- 严禁引入 Prometheus、OpenTelemetry 及其衍生组件，现有部署必须拆除并迁移至轻量化替代方案（如本地日志轮转、简单指标聚合脚本、脚本化健康检查）。
- 替代方案需确保数据可导出、可回溯，并在 Serena 登记运行方式、采样频率与维护人。
- 如需可视化，优先选用现有开源工具的简化模式（如静态报表生成），禁止搭建复杂链路。

## 4. 标准工作流
### 4.1 最小循环
1. Research：先通过 Sequential Thinking MCP 输出可追溯思考链，再由 Serena 协调必要的本地检索与结构分析，过程中借助 `serena__find_symbol`、`serena__search_for_pattern` 等结构化检索接口定位代码上下文，随后按 Context7 → DeepWiki → 其他渠道的顺序补充外部证据，并依 2.5 操作留痕实时写入 Serena。
2. Plan：通过 `update_plan` 或 `TodoWrite` 维护步骤、状态与验收标准。
3. Implement：小步提交，保持最小变更并补充中文文档/注释。
4. Verify：由 AI 驱动的本地自动执行流程运行必要的构建、测试、性能与回归检查，并将结果同步至 Serena。
5. Deliver：总结变更、风险、验证结果，按 2.5 操作留痕要求实时写入 Serena 知识记忆并清理过期记录。

### 4.2 阶段关卡
| 阶段 | Gate 目标 | 关键产物与要求 |
| --- | --- | --- |
| P0 启动 | 对齐目标、范围、SLO/SLI 与非目标 | 任务卡（目标/范围/成功标准/时间线/责任人） |
| P1 检索与证据 | 证据充分且可信 | 证据表、要点初判（含版本与日期），并登记至 Serena 知识记忆 |
| P2 深度评估 | 问题闭环与多方验证 | 资产盘点、SBOM、静态分析与架构评估报告；识别自研组件并制定替换计划 |
| P3 重构蓝图 | 不兼容策略确定 | 技术选型对比矩阵、最终 ADR，明确自研组件退役路径 |
| P4 详细设计 | 设计完备可落地 | 系统设计说明书（SDS）、契约与图谱文本化 |
| P5 实现与质量 | 质量门禁全部达标 | 完整实现、测试报告、覆盖率与质量证据；验证 Prom/Otel 已全部移除 |
| P6 验证与发布 | 可运维且可回滚 | 性能与观测性报告、发布与回滚方案，验证轻量观测方案稳定 |
| P7 交付与复盘 | 闭环完成，可审计 | 交付清单、证据存档、复盘结论实时写入 Serena 知识记忆（覆盖旧版本） |

## 5. 质量与安全门槛
### 5.1 质量门禁
- 构建、编译、静态检查必须零报错；完整测试矩阵全部通过。
- 单元、集成、契约、E2E、性能、压力、容量、混沌与回归测试覆盖关键路径及异常分支，总体覆盖率 ≥ 90%。
- 生成覆盖率报告与 SBOM，确认依赖无高危 CVE。
- 构建流程需可重复、版本锁定、可审计并可回滚。

### 5.2 测试与观测
- 单元测试需隔离、可重复、快速；必要时 Mock 外部依赖。
- 集成/契约测试基于接口契约自动校验；E2E 覆盖关键业务与异常路径并校验数据一致性。
- 性能测试包含冷/热启动、负载/压力/容量与故障注入，输出 P95/P99、吞吐、CPU、内存等基准并与基线对比。
- 观测性应采用轻量可维护的方案（脚本化日志分析、轻量指标收集等），严禁使用 Prom/Otel 体系。

### 5.3 技术标准
- 遵循 SOLID、DDD、关注点分离、DRY 原则。
- 优先使用活跃维护的主流库；若存在官方 SDK 必须优先选择并锁定最新稳定版。
- 坚决减少自研解决方案，所有新增功能需优先评估开源或商业成熟方案，评估结论写入 Serena。
- 采用 Conventional Commits，PR 模板需记录动机、变更、测试、风险、回滚与关联 ADR。

### 5.4 最低安全基线
- 保留必要的身份、授权与依赖风险控制；禁止引入额外安全设计。
- 对现有超出最低基线的安全机制进行梳理并拆除，多余控制项需在 Serena 记录移除过程与影响评估。
- 敏感字段审计需打码，禁止持久化明文秘钥。

## 6. 交付与存档
- 发布需记录迁移脚本、割接窗口、回滚方案及完成状态，并在 Serena 知识记忆同步归档与更新（详见 2.5 操作留痕）。
- 所有图表、Mermaid/PlantUML 源文件及导出结果一律以文本或附件形式存入 Serena，禁止在仓库或线下目录存放。
- 在 Serena 知识记忆中归档 PDF/网页快照/数据及校验和，标注“最后验证日期”，结论需与证据编号一一对应。
- 针对拆除 Prom/Otel、自研组件替换、额外安全机制移除等关键任务，需在 Serena 维护里程碑与责任人，确保持续跟踪直至完成。

## 7. 模板与清单
### 7.1 证据表（CSV 头）
#### ```
id,type,source,title,version,publish_date,access_date,link,applies_to
#### ```

### 7.2 技术选型对比矩阵（CSV 头）
#### ```
option,version,maturity,community_health,performance,security,maintainability,learning_cost,ecosystem,compatibility,cost,risk,score,notes,evidences
#### ```

### 7.3 性能基准配置（YAML 示例）
#### ```
target: service-x
workload:
  rps: [100, 500, 1000]
  duration: 5m
metrics:
  - p50_latency_ms
  - p95_latency_ms
  - p99_latency_ms
  - throughput_rps
  - cpu_pct
  - mem_mb
pass_thresholds:
  p99_latency_ms: 200
  throughput_rps: 800
#### ```

### 7.4 风险登记表（CSV 头）
#### ```
id,description,category,likelihood,impact,mitigation,owner,status
#### ```

### 7.5 ADR 模板（Markdown）
#### ```
# ADR-NN: <决策标题>
日期：YYYY-MM-DD  | 状态：提议/通过/废弃

## 背景
<业务背景与问题描述>

## 备选方案
- 方案A：优缺点
- 方案B：优缺点

## 决策
<选定方案与理由（含权衡矩阵得分）>

## 后果
<正/负面影响、迁移/回滚影响>

## 引用
- [证据#] ...
#### ```

### 7.6 系统设计说明书（SDS）目录
- 概述与目标（含 SLO/SLI 与成功标准）
- 架构与部署（Mermaid/PlantUML）
- 数据流/时序与错误路径
- 接口契约、错误码、限流策略
- 数据模型与一致性/事务策略
- 观测性与容量规划
- 安全与合规
- 风险与缓解措施
- 验收与发布计划

## 8. 工程师行为准则
- **求证先行**：查询胜过猜测，确认胜过假设；任何关键结论需标注明献或工具结果。
- **标准优先**：遵循规范胜过随意，能复用主流生态时不得自行实现。
- **质量共担**：测试胜过跳过，主动补齐验证证据并推动缺口弥合。
- **透明反馈**：如实记录不确定性、风险与偏差，并向 Serena 归档，确保团队共享。
- **持续精进**：总结复盘沉淀改进点，推动流程、工具与知识库迭代。